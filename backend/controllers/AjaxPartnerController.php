<?php


namespace backend\controllers;


use common\helper\Helper;
use yii\helpers\ArrayHelper;
use yii\web\BadRequestHttpException;
use GuzzleHttp\Client;

class AjaxPartnerController extends BaseController
{
    public $sheetID = "1BKMRrB0aPJPJmJZoTrqQbk6hNuuhOHjFezvZdT9aS6c";
    const PAYED = 'da-thanh-toan';
    const TRANSFERRED = 'da-doi-soat';
    const EXPORT_WAREHOUSE = 'da-xuat-hang';
    const IMPORT_WAREHOUSE = 'nhap';
    const NOT_SHIPPED = 'chua-xuat-hang';
    const INVENTORY = 'ton';
    const BROKEN = 'hong';
    const REFUND = 'hoan';

    public function init()
    {
        \Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;
        parent::init(); // TODO: Change the autogenerated stub
    }

    /**
     * @return mixed
     * @throws BadRequestHttpException
     */
    function actionGetWarehouse()
    {
        $partner = \Yii::$app->request->get('partner');
        try {
            $client = static::initClient();
            $service = new \Google_Service_Sheets($client);
            $range = "Data kho!A2:E";

            $response = $service->spreadsheets_values->get($this->sheetID, $range);

            $values = $response->getValues();
            $values = self::group_by(0, $values);
            $values = $values[$partner];
            $productGroup = self::group_by(2, $values);
            $data = [];

            foreach ($productGroup as $category => $value) {
                $importTotal = $exportTotal = $refund = $broken = $inventory = $not_shipped = 0;
                $products = self::group_by(1, $value);
                foreach ($products as $product => $column) {

                    foreach ($column as $key => $val) {
                        $status = Helper::toLower($val[3]);
                        $qty = (int)$val[4];
                        switch ($status) {
                            case self::EXPORT_WAREHOUSE:
                                $exportTotal += $qty;
                                break;
                            case self::IMPORT_WAREHOUSE:
                                $importTotal += $qty;
                                break;
                            case self::REFUND:
                                $refund += $qty;
                                break;
                            case self::NOT_SHIPPED:
                                $not_shipped += $qty;
                                break;
                            case self::BROKEN:
                                $broken += $qty;
                                break;
                            case self::INVENTORY:
                                $inventory += $qty;
                                break;
                            default:
                                break;
                        }
                    }
                    $data[$category][$product] = [
                        'product' => $product,
                        'category' => $category,
                        'broken' => $broken,
                        'refund' => $refund,
                        'inventory' => $inventory,
                        'import' => $importTotal,
                        'export' => $exportTotal,
                        'not_shipped' => $not_shipped,
                    ];
                }
            }
            if (empty($values)) {
                throw new BadRequestHttpException("Dữ liệu trống!");
            }
        } catch (\Exception $e) {
            throw new BadRequestHttpException($e->getMessage());
        }
        return $data;
    }

    /**
     * @return mixed
     * @throws BadRequestHttpException
     */
    function actionGetOrder()
    {
        $partner = \Yii::$app->request->get('partner');
        try {
            $client = static::initClient();
            $service = new \Google_Service_Sheets($client);

            $range = "Data contact!A2:AR";

            $response = $service->spreadsheets_values->get($this->sheetID, $range);

            $values = $response->getValues();
            $data = self::group_by(12, $values);
            $values = $data[$partner];
            $phone = array_keys(self::group_by(4, $values));
            $C11 = array_keys(self::group_by(43, $values));
            $C8 = array_keys(self::group_by(39, $values));

            if (empty($values)) {
                throw new BadRequestHttpException("Dữ liệu trống!");
            }
        } catch (\Exception $e) {
            throw new BadRequestHttpException($e->getMessage());
        }
        return [
            'data' => $values,
            'filter' => [
                'phone' => $phone,
                'C8' => $C8,
                'C11' => $C11
            ]
        ];
    }


    /**
     * @return mixed
     * @throws BadRequestHttpException
     */
    function actionGetSale()
    {
        $dataSet = [];
        $partner = \Yii::$app->request->get('partner');
        try {
            $client = static::initClient();
            $service = new \Google_Service_Sheets($client);

            $range = "Data contact!A2:BG";

            $response = $service->spreadsheets_values->get($this->sheetID, $range);

            $values = $response->getValues();
            if (empty($values)) {
                throw new BadRequestHttpException("Dữ liệu trống!");
            }
            $data = self::group_by(12, $values);
            $partner = $data[$partner];
            $data = self::group_by(2, $partner);
            $product = array_keys(self::group_by(6, $partner));
            $source = array_keys(self::group_by(11, $partner));
            $marketer = array_keys(self::group_by(13, $partner));
            $sale = array_keys(self::group_by(14, $partner));
            $labels = array_keys($data);
            $sumRevenueC8 = $totalC3 = $totalC8 = $totalC11 = $total_C8_C3 = $total_C11_C3 = $total_C11_C8 = 0;

            foreach ($labels as $k => $label) {
                $C3 = ArrayHelper::getColumn($data[$label], 51);
                $C8 = ArrayHelper::getColumn($data[$label], 56);
                $C4 = ArrayHelper::getColumn($data[$label], 52);
                $C6 = ArrayHelper::getColumn($data[$label], 54);
                $C7 = ArrayHelper::getColumn($data[$label], 55);
                $C11 = ArrayHelper::getColumn($data[$label], 57);
                $rev_c8 = ArrayHelper::getColumn($data[$label], 40);

                $sumbC3 = array_sum($C3);
                $sumbC8 = array_sum($C8);
                $sumbC6 = array_sum($C6);
                $sumbC7 = array_sum($C7);
                $sumbC4 = array_sum($C4);
                $sumbC11 = array_sum($C11);
                $sumRevenueC8 = array_sum($rev_c8);

                $dataSet["C3"][$k] = $sumbC3;
                $dataSet["C6"][$k] = $sumbC6;
                $dataSet["C7"][$k] = $sumbC7;
                $dataSet["C4"][$k] = $sumbC4;
                $dataSet["C8"][$k] = $sumbC8;
                $dataSet["C8_C3"][$k] = $sumbC8 > 0 ? round($sumbC8 / $sumbC3 * 100) : 0;
                $dataSet["C11"][$k] = $sumbC11;

                $totalC3 = $totalC3 + $sumbC3;
                $totalC11 = $totalC11 + $sumbC11;
                $totalC8 = $totalC8 + $sumbC8;
                $sumRevenueC8 = $sumRevenueC8 + $sumRevenueC8;
            }
            $total_C8_C3 = $totalC8 > 0 ? round($totalC8 / $totalC3 * 100) : 0;
            $total_C11_C3 = $totalC11 > 0 ? round($totalC11 / $totalC3 * 100) : 0;
            $total_C11_C8 = $totalC11 > 0 ? round($totalC11 / $totalC8 * 100) : 0;

        } catch (\Exception $e) {
            throw new BadRequestHttpException($e->getMessage());
        }

        return [
            'labels' => $labels,
            'dataSet' => $dataSet,
            'calculate' => [
                'revenue_c8' => $sumRevenueC8,
                'C8' => $totalC8,
                'C3' => $totalC3,
                'C11' => $totalC11,
                'C11_C3' => $total_C11_C3,
                'C11_C8' => $total_C11_C8,
                'C8_C3' => $total_C8_C3
            ],
            'filter' => [
                'product' => array_merge(['' => 'Null'], $product),
                'source' => array_merge(['' => 'Null'], $source),
                'marketer' => array_merge(['' => 'Null'], $marketer),
                'page' => [],
                'sale' => array_merge(['' => 'Null'], $sale),
                'date' => null
            ]
        ];
    }

    static function convertNumber($arr)
    {
        return array_sum(array_map(function ($item) {
            return str_replace(',', '.', $item);
        }, $arr));
    }

    function actionGetFinance()
    {
        $dataSet = [];
        $partner = \Yii::$app->request->get('partner');
        try {
            $client = static::initClient();
            $service = new \Google_Service_Sheets($client);

            $range = "Data contact!A2:BG";

            $response = $service->spreadsheets_values->get($this->sheetID, $range);

            $values = $response->getValues();
            if (empty($values)) {
                throw new BadRequestHttpException("Dữ liệu trống!");
            }
            $partners = self::group_by(12, $values);
            $data = $partners[$partner];
            $data = self::group_by(2, $data);
            $labels = array_keys($data);
            $totalC8 =
            $totalC13 =
            $totalC11 =
            $dv_da_dx = $thu_ho_da_dx = $vch_da_dx = $tien_da_dx =
            $total_dv = $total_thu_ho = $total_vch = $total_tien = 0;
            //$dv_chua_dx = $thu_ho_chua_dx = $vch_chua_dx = $tien_dchua_dx = 0;
            asort($labels);

            foreach ($labels as $k => $label) {
                $col8 = ArrayHelper::getColumn($data[$label], 40);
                $col8 = self::convertNumber($col8);
                $dataSet['C8'][$k] = $col8;
                $totalC11K = 0;
                $totalC13K = 0;

                foreach ($data[$label] as $column => $value) {
                    $statusC11 = Helper::toLower($value[43]);
                    $statusC13 = Helper::toLower($value[46]);
                    $numC8 = (double)$value[40];
                    $numDV = self::convertNumber([$value[48]]);
                    $numThuHo = self::convertNumber([$value[45]]);
                    $numVCH = self::convertNumber([$value[44]]);
                    $numTien = self::convertNumber([$value[49]]);
                    $totalC8 += $numC8;

                    $total_dv += $numDV;
                    $total_vch += $numVCH;
                    $total_tien += $numTien;
                    $total_thu_ho += $numThuHo;

                    if ($statusC11 === self::PAYED) {
                        $totalC11 += $numC8;
                        $totalC11K += $numC8;
                    }
                    if ($statusC13 === self::TRANSFERRED) {
                        $totalC13 += $numC8;
                        $totalC13K += $numC8;
                        $dv_da_dx += $numDV;
                        $thu_ho_da_dx += $numThuHo;
                        $vch_da_dx += $numVCH;
                        $tien_da_dx += $numTien;
                    }
                }
                $dataSet['C11'][$k] = $totalC11K;
                $dataSet['C13'][$k] = $totalC13K;
            }

        } catch (\Exception $e) {
            throw new BadRequestHttpException($e->getMessage());
        }
        return [
            'calculate' => [
                'C11_C8' => round($totalC11 / $totalC8 * 100, 2),
                'C13' => round($totalC13, 2),
                'C11' => round($totalC11, 2),
                'total_dv' => round($total_dv, 2),
                'total_thu_ho' => round($total_thu_ho, 2),
                'total_vch' => round($total_vch, 2),
                'dv_da_dx' => round($dv_da_dx, 2),
                'thu_ho_da_dx' => round($thu_ho_da_dx, 2),
                'vch_da_dx' => round($vch_da_dx, 2),
                'tien_da_dx' => round($tien_da_dx, 2),
                'C13_chua_dx' => round($totalC11 - $totalC13, 2),
                'dv_chua_dx' => round($total_dv - $dv_da_dx, 2),
                'vch_chua_dx' => round($total_vch - $vch_da_dx, 2),
                'thu_ho_chua_dx' => round($total_thu_ho - $thu_ho_da_dx, 2),
                'tien_chua_dx' => round($total_tien - $tien_da_dx, 2)
            ],
            'labels' => $labels,
            'dataSet' => $dataSet
        ];
    }

    static function initClient()
    {
        $client = new \Google_Client();
        $client->setClientId(GOOGLE_DRIVE_CLIENT_ID);
        $client->setClientSecret(GOOGLE_DRIVE_CLIENT_SECRET);
        $client->refreshToken(GOOGLE_DRIVE_REFRESH_TOKEN);
        $client->setScopes(\Google_Service_Sheets::SPREADSHEETS);
        $client->setAccessType('offline');
//        $client->setHttpClient(new Client([
//            'verify' => "D:\cacert.pem"
//        ]));
        return $client;
    }

    static function group_by($key, $data)
    {
        $result = array();

        foreach ($data as $val) {
            if (array_key_exists($key, $val)) {
                $result[$val[$key]][] = $val;
            } else {
                $result[""][] = $val;
            }
        }

        return $result;
    }
}